
dm "clear out;clear log;ODSRESULTS;clear";

OPTIONS FULLSTIMER SASTRACE=',,,d' sastraceloc=saslog;
libname ORA12015;
libname ORA12015 oracle user='DARTIES1' password='DARTIES1' 
 path="(DESCRIPTION= 
          (ADDRESS_LIST=
            (ADDRESS= (PROTOCOL=TCP)(HOST=ora12c)(PORT=1521))
             )
              (CONNECT_DATA= 
         	     (SID=ORAETUD)
          )
        )
       ";


PROC SQL STIMER _method _tree EXEC;
connect to oracle as ora12c(
user='DARTIES1'
orapw='DARTIES1'
 path="(DESCRIPTION= 
          (ADDRESS_LIST=
            (ADDRESS= (PROTOCOL=TCP)(HOST=ora12c)(PORT=1521))
             )
              (CONNECT_DATA= 
         	     (SID=ORAETUD)
          )
        )
       "
) ;


%let SELECT_COURS=1;


/* Conception de la table contenant les valeurs temporelles */

%let SELECT_CUMUL=1;


CREATE TABLE work.REQUETE_TEMPS AS
SELECT * FROM connection to ora12c(
WITH RECURSIVE_CUMULATED_MONTH1(CODE,ID_TEMPS,YEAR_REF, MONTH_REF) AS (
SELECT ANNEE||'_4_'||MOIS, ID_TEMPS,ANNEE,MOIS  from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY')) 
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,MOIS  from RECURSIVE_CUMULATED_MONTH1, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_MONTH1.YEAR_REF AND DIM_TEMPS.MOIS=RECURSIVE_CUMULATED_MONTH1.MONTH_REF-1 AND DIM_TEMPS.MOIS>=1
),
RECURSIVE_CUMULATED_MONTH(CODE,ID_TEMPS,YEAR_REF, MONTH_REF) AS (
SELECT ANNEE||'_4_'||MOIS, ID_TEMPS,ANNEE,MOIS  from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1 
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,MOIS  from RECURSIVE_CUMULATED_MONTH, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_MONTH.YEAR_REF AND DIM_TEMPS.MOIS=RECURSIVE_CUMULATED_MONTH.MONTH_REF-1 AND DIM_TEMPS.MOIS>=1
) ,
RECURSIVE_CUMULATED_MONTH2(CODE,ID_TEMPS,YEAR_REF, MONTH_REF) AS (
SELECT ANNEE||'_4_'||MOIS, ID_TEMPS,ANNEE,MOIS  from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2 
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,MOIS  from RECURSIVE_CUMULATED_MONTH2, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_MONTH2.YEAR_REF AND DIM_TEMPS.MOIS=RECURSIVE_CUMULATED_MONTH2.MONTH_REF-1 AND DIM_TEMPS.MOIS>=1
) ,
RECURSIVE_CUMULATED_TRIMESTER1(CODE,ID_TEMPS,YEAR_REF, TRIMESTER_REF) AS (
SELECT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS,ANNEE,TRIMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,TRIMESTRE  from RECURSIVE_CUMULATED_TRIMESTER1, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_TRIMESTER1.YEAR_REF AND DIM_TEMPS.TRIMESTRE=RECURSIVE_CUMULATED_TRIMESTER1.TRIMESTER_REF-1 AND DIM_TEMPS.TRIMESTRE>=1
),
RECURSIVE_CUMULATED_TRIMESTER(CODE,ID_TEMPS,YEAR_REF, TRIMESTER_REF) AS (
SELECT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS,ANNEE,TRIMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,TRIMESTRE  from RECURSIVE_CUMULATED_TRIMESTER, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_TRIMESTER.YEAR_REF AND DIM_TEMPS.TRIMESTRE=RECURSIVE_CUMULATED_TRIMESTER.TRIMESTER_REF-1 AND DIM_TEMPS.TRIMESTRE>=1
), 
RECURSIVE_CUMULATED_TRIMESTER2(CODE,ID_TEMPS,YEAR_REF, TRIMESTER_REF) AS (
SELECT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS,ANNEE,TRIMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,TRIMESTRE  from RECURSIVE_CUMULATED_TRIMESTER2, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_TRIMESTER2.YEAR_REF AND DIM_TEMPS.TRIMESTRE=RECURSIVE_CUMULATED_TRIMESTER2.TRIMESTER_REF-1 AND DIM_TEMPS.TRIMESTRE>=1
), 
RECURSIVE_CUMULATED_SEMESTER1(CODE,ID_TEMPS,YEAR_REF, SEMESTER_REF) AS (
SELECT ANNEE||'_2_'||SEMESTRE,ID_TEMPS,ANNEE,SEMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,SEMESTRE  from RECURSIVE_CUMULATED_SEMESTER1, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_SEMESTER1.YEAR_REF AND DIM_TEMPS.SEMESTRE=RECURSIVE_CUMULATED_SEMESTER1.SEMESTER_REF-1 AND DIM_TEMPS.SEMESTRE>=1
) ,
RECURSIVE_CUMULATED_SEMESTER2(CODE,ID_TEMPS,YEAR_REF, SEMESTER_REF) AS (
SELECT ANNEE||'_2_'||SEMESTRE,ID_TEMPS,ANNEE,SEMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,SEMESTRE  from RECURSIVE_CUMULATED_SEMESTER2, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_SEMESTER2.YEAR_REF AND DIM_TEMPS.SEMESTRE=RECURSIVE_CUMULATED_SEMESTER2.SEMESTER_REF-1 AND DIM_TEMPS.SEMESTRE>=1
) ,
RECURSIVE_CUMULATED_SEMESTER(CODE,ID_TEMPS,YEAR_REF, SEMESTER_REF) AS (
SELECT ANNEE||'_2_'||SEMESTRE,ID_TEMPS,ANNEE,SEMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,SEMESTRE  from RECURSIVE_CUMULATED_SEMESTER, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_SEMESTER.YEAR_REF AND DIM_TEMPS.SEMESTRE=RECURSIVE_CUMULATED_SEMESTER.SEMESTER_REF-1 AND DIM_TEMPS.SEMESTRE>=1
) 
SELECT TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))||'_1_'||TO_NUMBER(TO_CHAR(SYSDATE,'YYYY')) AS CODE,ID_TEMPS AS ID_TEMPS FROM DIM_TEMPS WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))
UNION ALL 
SELECT ANNEE||'_4_'||MOIS,  ID_TEMPS from DIM_TEMPS 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_MONTH1
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS from DIM_TEMPS T1
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND TRIMESTRE=T1.TRIMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_TRIMESTER1
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_2_'||SEMESTRE, ID_TEMPS from DIM_TEMPS T1 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND SEMESTRE=T1.SEMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_SEMESTER1
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT TO_CHAR(TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1)||'_1_'||TO_CHAR(TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1) ,ID_TEMPS  FROM DIM_TEMPS WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1 
UNION ALL
SELECT ANNEE||'_4_'||MOIS,  ID_TEMPS from DIM_TEMPS 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_MONTH
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS from DIM_TEMPS T1
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND TRIMESTRE=T1.TRIMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_TRIMESTER
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_2_'||SEMESTRE, ID_TEMPS from DIM_TEMPS T1 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND SEMESTRE=T1.SEMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_SEMESTER
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT TO_CHAR(TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2)||'_1_'||TO_CHAR(TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2) ,ID_TEMPS  FROM DIM_TEMPS WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2 
UNION ALL
SELECT ANNEE||'_4_'||MOIS,  ID_TEMPS from DIM_TEMPS 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_MONTH2
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS from DIM_TEMPS T1
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND TRIMESTRE=T1.TRIMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_TRIMESTER2
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_2_'||SEMESTRE, ID_TEMPS from DIM_TEMPS T1 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND SEMESTRE=T1.SEMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_SEMESTER2
WHERE &SELECT_CUMUL=0);


/* Conception de la table contenant les valeurs temporelles pour le cumul */

%let SELECT_CUMUL = 0;


CREATE TABLE work.REQUETE_TEMPS_CUMUL AS
SELECT * FROM connection to ora12c(
WITH RECURSIVE_CUMULATED_MONTH1(CODE,ID_TEMPS,YEAR_REF, MONTH_REF) AS (
SELECT ANNEE||'_4_'||MOIS, ID_TEMPS,ANNEE,MOIS  from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY')) 
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,MOIS  from RECURSIVE_CUMULATED_MONTH1, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_MONTH1.YEAR_REF AND DIM_TEMPS.MOIS=RECURSIVE_CUMULATED_MONTH1.MONTH_REF-1 AND DIM_TEMPS.MOIS>=1
),
RECURSIVE_CUMULATED_MONTH(CODE,ID_TEMPS,YEAR_REF, MONTH_REF) AS (
SELECT ANNEE||'_4_'||MOIS, ID_TEMPS,ANNEE,MOIS  from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1 
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,MOIS  from RECURSIVE_CUMULATED_MONTH, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_MONTH.YEAR_REF AND DIM_TEMPS.MOIS=RECURSIVE_CUMULATED_MONTH.MONTH_REF-1 AND DIM_TEMPS.MOIS>=1
) ,
RECURSIVE_CUMULATED_MONTH2(CODE,ID_TEMPS,YEAR_REF, MONTH_REF) AS (
SELECT ANNEE||'_4_'||MOIS, ID_TEMPS,ANNEE,MOIS  from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2 
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,MOIS  from RECURSIVE_CUMULATED_MONTH2, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_MONTH2.YEAR_REF AND DIM_TEMPS.MOIS=RECURSIVE_CUMULATED_MONTH2.MONTH_REF-1 AND DIM_TEMPS.MOIS>=1
) ,
RECURSIVE_CUMULATED_TRIMESTER1(CODE,ID_TEMPS,YEAR_REF, TRIMESTER_REF) AS (
SELECT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS,ANNEE,TRIMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,TRIMESTRE  from RECURSIVE_CUMULATED_TRIMESTER1, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_TRIMESTER1.YEAR_REF AND DIM_TEMPS.TRIMESTRE=RECURSIVE_CUMULATED_TRIMESTER1.TRIMESTER_REF-1 AND DIM_TEMPS.TRIMESTRE>=1
),
RECURSIVE_CUMULATED_TRIMESTER(CODE,ID_TEMPS,YEAR_REF, TRIMESTER_REF) AS (
SELECT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS,ANNEE,TRIMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,TRIMESTRE  from RECURSIVE_CUMULATED_TRIMESTER, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_TRIMESTER.YEAR_REF AND DIM_TEMPS.TRIMESTRE=RECURSIVE_CUMULATED_TRIMESTER.TRIMESTER_REF-1 AND DIM_TEMPS.TRIMESTRE>=1
), 
RECURSIVE_CUMULATED_TRIMESTER2(CODE,ID_TEMPS,YEAR_REF, TRIMESTER_REF) AS (
SELECT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS,ANNEE,TRIMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,TRIMESTRE  from RECURSIVE_CUMULATED_TRIMESTER2, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_TRIMESTER2.YEAR_REF AND DIM_TEMPS.TRIMESTRE=RECURSIVE_CUMULATED_TRIMESTER2.TRIMESTER_REF-1 AND DIM_TEMPS.TRIMESTRE>=1
), 
RECURSIVE_CUMULATED_SEMESTER1(CODE,ID_TEMPS,YEAR_REF, SEMESTER_REF) AS (
SELECT ANNEE||'_2_'||SEMESTRE,ID_TEMPS,ANNEE,SEMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,SEMESTRE  from RECURSIVE_CUMULATED_SEMESTER1, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_SEMESTER1.YEAR_REF AND DIM_TEMPS.SEMESTRE=RECURSIVE_CUMULATED_SEMESTER1.SEMESTER_REF-1 AND DIM_TEMPS.SEMESTRE>=1
) ,
RECURSIVE_CUMULATED_SEMESTER2(CODE,ID_TEMPS,YEAR_REF, SEMESTER_REF) AS (
SELECT ANNEE||'_2_'||SEMESTRE,ID_TEMPS,ANNEE,SEMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,SEMESTRE  from RECURSIVE_CUMULATED_SEMESTER2, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_SEMESTER2.YEAR_REF AND DIM_TEMPS.SEMESTRE=RECURSIVE_CUMULATED_SEMESTER2.SEMESTER_REF-1 AND DIM_TEMPS.SEMESTRE>=1
) ,
RECURSIVE_CUMULATED_SEMESTER(CODE,ID_TEMPS,YEAR_REF, SEMESTER_REF) AS (
SELECT ANNEE||'_2_'||SEMESTRE,ID_TEMPS,ANNEE,SEMESTRE from DIM_TEMPS
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1  
UNION ALL
SELECT CODE, DIM_TEMPS.ID_TEMPS,ANNEE,SEMESTRE  from RECURSIVE_CUMULATED_SEMESTER, DIM_TEMPS 
WHERE DIM_TEMPS.ANNEE=RECURSIVE_CUMULATED_SEMESTER.YEAR_REF AND DIM_TEMPS.SEMESTRE=RECURSIVE_CUMULATED_SEMESTER.SEMESTER_REF-1 AND DIM_TEMPS.SEMESTRE>=1
) 
SELECT TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))||'_1_'||TO_NUMBER(TO_CHAR(SYSDATE,'YYYY')) AS CODE,ID_TEMPS AS ID_TEMPS FROM DIM_TEMPS WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))
UNION ALL 
SELECT ANNEE||'_4_'||MOIS,  ID_TEMPS from DIM_TEMPS 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_MONTH1
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS from DIM_TEMPS T1
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND TRIMESTRE=T1.TRIMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_TRIMESTER1
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_2_'||SEMESTRE, ID_TEMPS from DIM_TEMPS T1 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND SEMESTRE=T1.SEMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_SEMESTER1
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT TO_CHAR(TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1)||'_1_'||TO_CHAR(TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1) ,ID_TEMPS  FROM DIM_TEMPS WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1 
UNION ALL
SELECT ANNEE||'_4_'||MOIS,  ID_TEMPS from DIM_TEMPS 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_MONTH
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS from DIM_TEMPS T1
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND TRIMESTRE=T1.TRIMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_TRIMESTER
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_2_'||SEMESTRE, ID_TEMPS from DIM_TEMPS T1 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-1  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND SEMESTRE=T1.SEMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_SEMESTER
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT TO_CHAR(TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2)||'_1_'||TO_CHAR(TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2) ,ID_TEMPS  FROM DIM_TEMPS WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2 
UNION ALL
SELECT ANNEE||'_4_'||MOIS,  ID_TEMPS from DIM_TEMPS 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_MONTH2
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_3_'||TRIMESTRE,ID_TEMPS from DIM_TEMPS T1
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND TRIMESTRE=T1.TRIMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_TRIMESTER2
WHERE &SELECT_CUMUL=0
UNION ALL
SELECT DISTINCT ANNEE||'_2_'||SEMESTRE, ID_TEMPS from DIM_TEMPS T1 
WHERE ANNEE=TO_NUMBER(TO_CHAR(SYSDATE,'YYYY'))-2  AND MOIS IN (SELECT DISTINCT MOIS FROM DIM_TEMPS WHERE ANNEE=T1.ANNEE AND SEMESTRE=T1.SEMESTRE) 
AND &SELECT_CUMUL=1
UNION ALL
SELECT DISTINCT CODE,ID_TEMPS FROM RECURSIVE_CUMULATED_SEMESTER2
WHERE &SELECT_CUMUL=0);




/* On tri la table faits_ventes par l'ID de la famille de produit et par l'ID de magasin*/
PROC SORT DATA=ORA12015.DWR_FAITS_VENTES
		  OUT= WORK.FAITS_VENTES_TRI;
		BY ID_FAMILLE_PRODUIT ID_MAGASIN ID_TEMPS;
RUN;

/* On merge la table triée précedemment avec la table Dim_Famille_Produit pour avoir le label du produit*/
DATA WORK.MERGE_FAITS_PRODUIT;
	MERGE WORK.FAITS_VENTES_TRI (in=a)
		  ORA12015.DIM_FAMILLE_PRODUIT(in=b);
	BY ID_FAMILLE_PRODUIT;
	if a and b then output;
RUN;

DATA WORK.MERGE1;
	MERGE ORA12015.UTILISATEUR (in=a)
		  ora12015.PROFIL(in=b);
	BY ID_PROFIL;
	if a and b then output;
run;

DATA WORK.MERGE2;
	MERGE WORK.MERGE1(in=a)
		  ORA12015.SECURITE(in=b);
	BY ID_PROFIL;
	if a and b then output;
run;

PROC SORT DATA=WORK.MERGE2;
	BY ID_MAGASIN;
run;

DATA WORK.MERGE3;
	MERGE WORK.MERGE2 (in=a)
		  ORA12015.DIM_MAGASIN(in=b);
	BY ID_MAGASIN;
	if a and b then output;
run; 

PROC SQL;
	CREATE TABLE WORK.MERGE4 AS 
		SELECT * FROM WORK.MERGE3
		INNER JOIN ORA12015.DIM_DEPARTEMENT ON DIM_DEPARTEMENT.ID_DEPARTEMENT = MERGE3.DEP;
quit;

PROC SORT DATA= WORK.MERGE4;
by ID_ENSEIGNE;
run;


DATA WORK.MERGE5;
	MERGE WORK.MERGE4(in=a)
		  ORA12015.DIM_ENSEIGNE(in=b);
	BY ID_ENSEIGNE;
	if a and b then output;
run;

PROC SORT DATA=WORK.REQUETE_TEMPS;
by code;
run;

DATA WORK.MERGE6;
	MERGE WORK.REQUETE_TEMPS (in=a)
		  ORA12015.SELECT_TEMPS (in=b);
	BY CODE;
	if a and b then output;
run; 

PROC SORT DATA=WORK.MERGE5;
by ID_MAGASIN;
run;

PROC SORT DATA=WORK.MERGE_FAITS_PRODUIT;
by ID_MAGASIN;
run;

DATA WORK.MERGE7;
	MERGE WORK.MERGE_FAITS_PRODUIT (in=a)
		  WORK.MERGE5(in=b);
	BY ID_MAGASIN;
	if a and b then output;
run;


PROC SORT DATA=WORK.MERGE6;
by ID_TEMPS;
run;

PROC SORT DATA=WORK.MERGE7;
by ID_TEMPS;
run;

DATA WORK.MERGE8;
	MERGE WORK.MERGE6
		  WORK.MERGE7;
	BY ID_TEMPS;
run; 


PROC SORT DATA=WORK.MERGE8;
by id_famille_produit id_magasin;
run;


DATA WORK.DATATABLE2;
	SET WORK.MERGE8;
	by id_famille_produit id_magasin ;


	/* Definition de l'année et du mois en extrayant ces valeur de ID_TEMPS */
	ANNEE = SUBSTR(ID_TEMPS,1,4);
	MOIS = SUBSTR(ID_TEMPS,5,2);
	
	id_i=0;
	if indicateur="CA" then id_i=1;
	if indicateur="VENTES" then id_i=2;
	if indicateur="MARGE" then id_i=3;

RUN;

/* Création de la table de cumul */
PROC SORT DATA=WORK.REQUETE_TEMPS_cumul;
by code;
run;

DATA WORK.MERGE6;
	MERGE WORK.REQUETE_TEMPS_cumul (in=a)
		  ORA12015.SELECT_TEMPS (in=b);
	BY CODE;
	if a and b then output;
run; 

PROC SORT DATA=WORK.MERGE5;
by ID_MAGASIN;
run;

PROC SORT DATA=WORK.MERGE_FAITS_PRODUIT;
by ID_MAGASIN;
run;

DATA WORK.MERGE7;
	MERGE WORK.MERGE_FAITS_PRODUIT (in=a)
		  WORK.MERGE5(in=b);
	BY ID_MAGASIN;
	if a and b then output;
run;


PROC SORT DATA=WORK.MERGE6;
by ID_TEMPS;
run;

PROC SORT DATA=WORK.MERGE7;
by ID_TEMPS;
run;

DATA WORK.MERGE8;
	MERGE WORK.MERGE6
		  WORK.MERGE7;
	BY ID_TEMPS;
run; 


PROC SORT DATA=WORK.MERGE8;
by id_famille_produit id_magasin;
run;


DATA WORK.DATATABLE2_cumul;
	SET WORK.MERGE8;
	by id_famille_produit id_magasin ;


	/* Definition de l'année et du mois en extrayant ces valeur de ID_TEMPS */
	ANNEE = SUBSTR(ID_TEMPS,1,4);
	MOIS = SUBSTR(ID_TEMPS,5,2);
	
	id_i=0;
	if indicateur="CA" then id_i=1;
	if indicateur="VENTES" then id_i=2;
	if indicateur="MARGE" then id_i=3;

RUN;

